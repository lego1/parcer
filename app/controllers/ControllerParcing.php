<?phpclass ControllerParcing extends Controller {    function index(){		$category = $this->loadModel('category');		$categories = $category->getCategories('WHERE link != ""');		/*		list($time,$ms) = explode(" ", microtime());		$first_time = $time + $ms;		*/		if (Tools::getValue('value') == 0) {			$date[0] = 'сегодня';			$pages = 5;		}		elseif (Tools::getValue('value') == 1) {			$date[0] = 'сегодня';			$date[1] = 'вчера';			$pages = 15;		}		elseif (Tools::getValue('value') > 1) {			$date[0] = 'сегодня';			$date[1] = 'вчера';			for ($i = Tools::getValue('value'); $i > 1; $i--) {				$time = mktime(date('H'), date('i'), date('s'), date('m'), date('d')-$i, date('Y'));				$date[$i] = date("d.m", $time);			}			$pages = 50;		}		ksort($date);				$objects = array();		$counter = 0;				foreach ($categories as $category) {			preg_match_all('/[0-9]{1,}/', $category['link'], $matches);			for ($i=1; $i<=$pages; $i++) {				$site = file_get_html('http://www.irr.ua/filtersort=PlacingDate-True;/'.$matches[0][0].'/page'.$i.'/size50/');				foreach ($site->find('tr.classicAd') as $k => $object){					foreach ($date as $temp) {						if (trim($object->last_child()->first_child()->plaintext) == $temp) {							$objects[$counter]['id_category'] = $category['id_category'];							$objects[$counter]['id_irr'] = $object->id;							foreach ($object->children as $child) {								$class = trim(preg_replace('/inner/','',$child->class));								if ($class == 'price')									$objects[$counter]['price'] = trim($child->plaintext);								if ($class == 'title')									$objects[$counter]['title'] = trim($child->plaintext);							}							$counter++;						}					}				}				$site->clear();				unset($site);			}		}		foreach ($objects as $key=>$object) {			$site = file_get_html('http://www.irr.ua/advert/'.$object['id_irr'].'/');			foreach($site->find('.rounded_corners') as $info){				$matches = null;				preg_match_all('/[\x80-\xFF]+\:\s+([\x80-\xFF]+)/i', $info->plaintext, $matches);				if (isset($matches[1][0]) && $matches[1][0] != null && $matches[1][0] !== 'Заголовок')					$objects[$key]['district'] = trim($matches[1][0]);			}			foreach($site->find('p.description') as $k=>$info){							if (($k+1)%2 == 0) {					$matches = null;					$phone = null;					preg_match_all('/[0-9-+]{6,}/i', $info->plaintext, $matches);					if (isset($matches[0][0]) && $matches[0][0] != null)						foreach($matches[0] as $match)							$phone .= preg_replace('/[\(\)\+\s-]/','',$match).'; ';					$objects[$key]['phone'] = trim($phone);					$matches = null;					$email = null;					preg_match_all('/[a-zA-Z0-9_\-\.]+@[a-z]+\.[a-z]+/i', $info->plaintext, $matches);					if (isset($matches[0][0]) && $matches[0][0] != null)						$objects[$key]['email'] = trim($matches[0][0]);				}			}			$site->clear();			unset($site);		}				/*		echo '<pre>';		print_r($objects);		echo '</pre>';		echo '<br>'.count($objects).'<br>';		die();		*/		$this->model->saveObjects($objects);				/*		list($time,$ms) = explode(" ", microtime());		$second_time = $time + $ms;		$loaded = $second_time - $first_time;		echo 'Страница сгенерирована за '.$loaded.' сек.';		*/	}}